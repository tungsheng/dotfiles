#!/bin/bash
set -e

# --- Configuration ---
# Core settings and data arrays for the setup script

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="1.0.0"
DRY_RUN=false
VERBOSE=false

# Dependencies: cmd_name|brew_pkg|dnf_pkg|apt_pkg
# Use "-" to skip a package manager (unavailable or not needed)
DEPS=(
    "stow|stow|stow|stow"
    "nvim|neovim|neovim|neovim"
    "fd|fd|fd-find|fd-find"
    "rg|ripgrep|ripgrep|ripgrep"
    "fzf|fzf|fzf|fzf"
    "zoxide|zoxide|-|zoxide"        # Fedora: installed via curl
    "tmux|tmux|tmux|tmux"
    "marksman|marksman|-|-"         # LSP for markdown, macOS only
    "-||-git|git"                   # Linux only packages
    "-||-curl|curl"
    "-||-zsh|zsh"
    "-||-unzip|unzip"
)

# Nerd fonts for terminal/editor icons (macOS Homebrew casks)
CASKS=("font-jetbrains-mono-nerd-font" "font-hurmit-nerd-font")

# Files/directories managed by stow (used for backup and health checks)
MANAGED_FILES=(.zshrc .bashrc .bash_profile .config/nvim .config/tmux .config/alacritty .config/gh .config/shell)

# External resources: local_path|source_url|fetch_type|display_name
EXTRAS=(
    "$HOME/.git-prompt.sh|https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh|curl|git-prompt.sh"
    "$HOME/.config/alacritty/themes|https://github.com/alacritty/alacritty-theme|git|Alacritty themes"
    "$HOME/.tmux/plugins/tpm|https://github.com/tmux-plugins/tpm|git|TPM"
)

# Paths to clean on uninstall: path|display_name
CLEANUPS=(
    "$HOME/.config/alacritty/themes|Alacritty themes"
    "$HOME/.git-prompt.sh|git-prompt.sh"
    "${XDG_DATA_HOME:-$HOME/.local/share}/zinit|Zinit"
    "$HOME/.local/share/nvim|Neovim data"
    "$HOME/.tmux/plugins|Tmux plugins"
)

# --- Logging ---
# Colored output functions for consistent messaging

RED='\033[0;31m' GREEN='\033[0;32m' YELLOW='\033[1;33m'
BLUE='\033[0;34m' CYAN='\033[0;36m' DIM='\033[2m' BOLD='\033[1m' NC='\033[0m'

print_banner() {
    echo
    echo -e "${BOLD}"
    cat <<'EOF'
       ██████╗   ██████╗  ████████╗ ███████╗ ██╗ ██╗     ███████╗ ███████╗
       ██╔══██╗ ██╔═══██╗ ╚══██╔══╝ ██╔════╝ ██║ ██║     ██╔════╝ ██╔════╝
       ██║  ██║ ██║   ██║    ██║    █████╗   ██║ ██║     █████╗   ███████╗
       ██║  ██║ ██║   ██║    ██║    ██╔══╝   ██║ ██║     ██╔══╝   ╚════██║
       ██████╔╝ ╚██████╔╝    ██║    ██║      ██║ ███████╗███████╗ ███████║
       ╚═════╝   ╚═════╝     ╚═╝    ╚═╝      ╚═╝ ╚══════╝╚══════╝ ╚══════╝
EOF
    echo -e "${NC}${DIM}       v${VERSION}${NC}"
    echo
}

log_info()    { echo -e "${BLUE}::${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC}  $1"; }
log_warn()    { echo -e "${YELLOW}!${NC}  $1"; }
log_error()   { echo -e "${RED}✗${NC}  $1" >&2; }
log_dim()     { echo -e "${DIM}   $1${NC}"; }
log_step()    { echo; echo -e "${BOLD}[$1/$2]${NC} $3"; }

log_result() {
    local passed=$1 failed=$2 warned=${3:-0}
    echo
    echo -ne "${DIM}Result:${NC} "
    [[ $passed -gt 0 ]] && echo -ne "${GREEN}${passed} passed${NC} "
    [[ $failed -gt 0 ]] && echo -ne "${RED}${failed} failed${NC} "
    [[ $warned -gt 0 ]] && echo -ne "${YELLOW}${warned} warnings${NC}"
    echo
}

# --- Helpers ---
# Utility functions used throughout the script

# Execute command, respecting dry-run and verbose modes
run_cmd() {
    if $DRY_RUN; then log_dim "dry-run: $*"
    else $VERBOSE && log_dim "$ $*"; "$@"; fi
}

# Check if a command exists in PATH
has_cmd() { command -v "$1" &>/dev/null; }

# Check if a file or directory exists
has_path() { [[ -e "$1" ]]; }

# Detect current OS/distribution
detect_os() {
    [[ "$OSTYPE" == "darwin"* ]] && echo "macos" && return
    has_cmd dnf && echo "fedora" && return
    has_cmd apt && echo "debian" && return
    echo "unknown"
}

# Extract package names from DEPS array for a specific package manager
# Args: $1 = column index (2=brew, 3=dnf, 4=apt)
get_packages() {
    local col=$1 packages=()
    for item in "${DEPS[@]}"; do
        local pkg=$(echo "$item" | cut -d'|' -f"$col")
        [[ "$pkg" != "-" ]] && packages+=("$pkg")
    done
    echo "${packages[@]}"
}

print_usage() {
    print_banner
    echo -e "${BOLD}Usage:${NC} ./setup [command] [options]"
    echo
    echo -e "${BOLD}Commands:${NC}"
    echo "    install     Install dotfiles and dependencies (default)"
    echo "    uninstall   Remove symlinks and optionally clean up"
    echo "    health      Check installation status"
    echo
    echo -e "${BOLD}Options:${NC}"
    echo "    -n, --dry-run   Preview changes without applying"
    echo "    -v, --verbose   Show detailed command output"
    echo "    -h, --help      Show this help message"
    exit 0
}

# --- Commands ---
# Main command implementations

cmd_health() {
    print_banner
    log_info "Running health check"
    local passed=0 failed=0 warned=0

    log_step 1 3 "Symlinks"
    for file in "${MANAGED_FILES[@]}"; do
        if [[ -L "$HOME/$file" || -d "$HOME/$file" ]]; then
            log_success "$file"; ((++passed))
        elif [[ -e "$HOME/$file" ]]; then
            log_warn "$file exists but not symlinked"; ((++warned))
        else
            log_error "$file missing"; ((++failed))
        fi
    done

    log_step 2 3 "Dependencies"
    for item in "${DEPS[@]}"; do
        IFS='|' read -r cmd _ _ _ <<< "$item"
        [[ "$cmd" == "-" ]] && continue
        has_cmd "$cmd" && { log_success "$cmd"; ((++passed)); } || { log_error "$cmd not found"; ((++failed)); }
    done

    log_step 3 3 "Plugin Managers"
    local plugins=(
        "${XDG_DATA_HOME:-$HOME/.local/share}/zinit|Zinit (zsh)"
        "$HOME/.local/share/nvim/lazy|Lazy.nvim"
        "$HOME/.tmux/plugins/tpm|TPM (tmux)"
    )
    for item in "${plugins[@]}"; do
        local path="${item%%|*}" name="${item##*|}"
        has_path "$path" && { log_success "$name"; ((++passed)); } || { log_warn "$name not installed"; ((++warned)); }
    done

    log_result $passed $failed $warned
}

cmd_uninstall() {
    print_banner
    log_info "Uninstalling dotfiles"
    $DRY_RUN && log_warn "Dry run mode - no changes will be made"

    has_cmd stow || { log_error "stow is required"; exit 1; }

    log_step 1 2 "Removing symlinks"
    cd "$DOTFILES_DIR"
    run_cmd stow --target="$HOME" --delete .
    log_success "Symlinks removed"

    if $DRY_RUN; then log_step 2 2 "Cleanup (skipped in dry-run)"; return; fi

    log_step 2 2 "Cleanup (optional)"
    for item in "${CLEANUPS[@]}"; do
        local path="${item%%|*}" name="${item##*|}"
        if has_path "$path"; then
            read -p "   Remove $name? [y/N] " -n 1 -r; echo
            [[ $REPLY =~ ^[Yy]$ ]] && { rm -rf "$path"; log_success "Removed $name"; } || log_dim "Kept $name"
        fi
    done
    rm -rf "$HOME/.local/state/nvim" "$HOME/.cache/nvim" 2>/dev/null || true

    echo
    log_success "Uninstall complete"
    log_dim "System packages were not removed"
}

cmd_install() {
    print_banner
    local os=$(detect_os)
    log_info "Installing dotfiles"
    log_dim "Detected OS: $os"
    $DRY_RUN && log_warn "Dry run mode - no changes will be made"

    # Backup existing configs before overwriting
    log_step 1 4 "Backup existing configs"
    local backed_up=0
    if ! $DRY_RUN; then
        for file in "${MANAGED_FILES[@]}"; do
            if [[ -e "$HOME/$file" && ! -L "$HOME/$file" ]]; then
                local backup_dir="$HOME/.dotfiles-backup-$(date +%Y%m%d-%H%M%S)"
                [[ ! -d "$backup_dir" ]] && mkdir -p "$backup_dir" && log_dim "Backup dir: $backup_dir"
                cp -r "$HOME/$file" "$backup_dir/"
                log_success "Backed up $file"
                ((++backed_up))
            fi
        done
    fi
    [[ $backed_up -eq 0 ]] && log_success "No backup needed"

    # Install system packages
    log_step 2 4 "Install dependencies"
    install_deps "$os"

    # Install external resources (themes, plugins)
    log_step 3 4 "Install extras"
    install_extras

    # Create symlinks via stow
    log_step 4 4 "Create symlinks"
    cd "$DOTFILES_DIR"
    if $DRY_RUN; then
        log_dim "Would run: stow --target=\$HOME --restow ."
        log_success "Ready to create symlinks"
    else
        stow --target="$HOME" --restow .
        log_success "Symlinks created"
    fi

    # Post-install instructions
    echo
    echo -e "${GREEN}${BOLD}Installation complete!${NC}"
    echo
    echo -e "${BOLD}Next steps:${NC}"
    echo -e "  ${CYAN}1.${NC} source ~/.zshrc"
    echo -e "  ${CYAN}2.${NC} p10k configure ${DIM}(customize prompt)${NC}"
    echo -e "  ${CYAN}3.${NC} nvim ${DIM}(plugins install automatically)${NC}"
    echo -e "  ${CYAN}4.${NC} tmux, then ${BOLD}Ctrl+Space I${NC} ${DIM}(install plugins)${NC}"
    echo
    log_dim "Run ./setup health to verify installation"
    echo
}

# --- Install Helpers ---
# Functions that support the install command

install_deps() {
    local os=$1

    case "$os" in
        macos)
            if ! has_cmd brew; then
                log_info "Installing Homebrew..."
                run_cmd /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                eval "$(/opt/homebrew/bin/brew shellenv)"
            fi
            log_success "Homebrew ready"

            log_info "Installing packages..."
            run_cmd brew install --quiet $(get_packages 2)

            log_info "Installing fonts..."
            run_cmd brew install --quiet --cask "${CASKS[@]}"
            ;;

        fedora)
            log_info "Installing EPEL repository..."
            run_cmd sudo dnf install -y epel-release 2>/dev/null || true

            log_info "Installing packages..."
            run_cmd sudo dnf install -y $(get_packages 3)

            # zoxide not in EPEL, install via official script
            if ! has_cmd zoxide; then
                log_info "Installing zoxide..."
                run_cmd curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
            fi
            ;;

        debian)
            log_info "Updating package index..."
            run_cmd sudo apt update

            log_info "Installing packages..."
            run_cmd sudo apt install -y $(get_packages 4)
            ;;

        *)
            log_warn "Unknown OS - install dependencies manually"
            log_dim "Required: stow neovim fd ripgrep fzf zoxide tmux git curl zsh"
            has_cmd stow || { log_error "stow is required"; exit 1; }
            return
            ;;
    esac

    log_success "Dependencies installed"
}

install_extras() {
    for item in "${EXTRAS[@]}"; do
        IFS='|' read -r path url type name <<< "$item"
        if has_path "$path"; then
            log_success "$name (already exists)"
        else
            log_info "Installing $name..."
            case "$type" in
                curl) run_cmd curl -sS -o "$path" "$url" ;;
                git)  run_cmd mkdir -p "$(dirname "$path")"
                      run_cmd git clone --depth 1 -q "$url" "$path" ;;
            esac
            log_success "$name installed"
        fi
    done
}

# --- Main ---
# Entry point and argument parsing

main() {
    local command="install"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            install|uninstall|health) command="$1"; shift ;;
            -n|--dry-run) DRY_RUN=true; shift ;;
            -v|--verbose) VERBOSE=true; shift ;;
            -h|--help)    print_usage ;;
            *)            log_error "Unknown option: $1"; print_usage ;;
        esac
    done

    cmd_$command
}

main "$@"
