#!/bin/bash

set -e

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Show usage
usage() {
    echo "Usage: $0 [install|uninstall]"
    echo ""
    echo "Commands:"
    echo "  install    Install dotfiles and dependencies (default)"
    echo "  uninstall  Remove dotfiles symlinks"
    exit 1
}

# Uninstall function
uninstall() {
    echo "Uninstalling dotfiles from $DOTFILES_DIR"

    if ! command -v stow &>/dev/null; then
        echo "Error: stow is required for uninstall. Please install it first."
        exit 1
    fi

    # Remove symlinks with stow
    echo "Removing symlinks with stow..."
    cd "$DOTFILES_DIR"
    stow --target="$HOME" --delete . 2>/dev/null || true

    echo ""
    read -p "Remove Alacritty themes? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$HOME/.config/alacritty/themes"
        echo "Removed Alacritty themes"
    fi

    read -p "Remove git-prompt.sh? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -f "$HOME/.git-prompt.sh"
        echo "Removed git-prompt.sh"
    fi

    read -p "Remove Zinit and zsh plugins? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "${XDG_DATA_HOME:-$HOME/.local/share}/zinit"
        echo "Removed Zinit"
    fi

    read -p "Remove Neovim data (plugins, cache)? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$HOME/.local/share/nvim"
        rm -rf "$HOME/.local/state/nvim"
        rm -rf "$HOME/.cache/nvim"
        echo "Removed Neovim data"
    fi

    read -p "Remove tmux plugins? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$HOME/.tmux/plugins"
        echo "Removed tmux plugins"
    fi

    echo ""
    echo "Dotfiles uninstalled successfully!"
    echo "Note: Installed packages (via brew/dnf/apt) were not removed."
    exit 0
}

# Parse command
case "${1:-install}" in
    install)
        ;;
    uninstall)
        uninstall
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        ;;
esac

echo "Installing dotfiles from $DOTFILES_DIR"

# macOS setup
if [[ "$OSTYPE" == "darwin"* ]]; then
    # Install Homebrew if not present
    if ! command -v brew &>/dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi

    # Install dependencies from Brewfile
    if [[ -f "$DOTFILES_DIR/Brewfile" ]]; then
        echo "Installing Homebrew dependencies..."
        brew bundle --file="$DOTFILES_DIR/Brewfile"
    fi

# Linux setup
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    if command -v dnf &>/dev/null; then
        echo "RHEL/AlmaLinux/Fedora detected. Installing dependencies..."
        sudo dnf install -y epel-release 2>/dev/null || true
        sudo dnf install -y stow neovim fd-find ripgrep fzf tmux git curl zsh

        # Install zoxide (not in standard repos)
        if ! command -v zoxide &>/dev/null; then
            echo "Installing zoxide..."
            curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
        fi
    elif command -v apt &>/dev/null; then
        echo "Debian/Ubuntu detected. Installing dependencies..."
        sudo apt update
        sudo apt install -y stow neovim fd-find ripgrep fzf zoxide tmux git curl zsh
    else
        echo "Linux detected. Please install dependencies manually:"
        echo "  stow neovim fd-find ripgrep fzf zoxide tmux git curl zsh"

        if ! command -v stow &>/dev/null; then
            echo "Error: stow is required. Please install it first."
            exit 1
        fi
    fi
fi

# Install bash git-prompt
if [[ ! -f "$HOME/.git-prompt.sh" ]]; then
    echo "Installing git-prompt..."
    curl -o "$HOME/.git-prompt.sh" https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh
fi

# Install alacritty themes if not present
if [[ ! -d "$HOME/.config/alacritty/themes" ]]; then
    echo "Installing Alacritty themes..."
    mkdir -p "$HOME/.config/alacritty/themes"
    git clone https://github.com/alacritty/alacritty-theme "$HOME/.config/alacritty/themes"
fi

# Use stow to create symlinks
echo "Creating symlinks with stow..."
cd "$DOTFILES_DIR"
stow --target="$HOME" --restow .

echo "Dotfiles installed successfully!"
echo ""
echo "Next steps:"
echo "  1. Restart your terminal or run: source ~/.zshrc"
echo "  2. Run 'p10k configure' to set up Powerlevel10k prompt"
echo "  3. Open nvim to let Lazy.nvim install plugins"
echo "  4. Run 'tmux' and press 'prefix + I' to install tmux plugins"
