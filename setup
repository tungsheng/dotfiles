#!/bin/bash
set -e

# ==============================================================================
# Configuration
# ==============================================================================

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="1.0.0"
DRY_RUN=false
VERBOSE=false

# ------------------------------------------------------------------------------
# Dependencies: cmd|brew|dnf|apt (use - for unavailable/skip)
# ------------------------------------------------------------------------------
DEPS=(
    "stow|stow|stow|stow"
    "nvim|neovim|neovim|neovim"
    "fd|fd|fd-find|fd-find"
    "rg|ripgrep|ripgrep|ripgrep"
    "fzf|fzf|fzf|fzf"
    "zoxide|zoxide|-|zoxide"           # DNF: install via curl
    "tmux|tmux|tmux|tmux"
    "marksman|marksman|-|-"            # macOS only
    "-||-git|git"                      # Linux only (skip on macOS)
    "-||-curl|curl"
    "-||-zsh|zsh"
    "-||-unzip|unzip"
)

# macOS fonts (casks)
CASKS=(
    "font-jetbrains-mono-nerd-font"
    "font-hurmit-nerd-font"
)

# Files managed by stow (for backup/health check)
MANAGED_FILES=(.zshrc .bashrc .bash_profile .config/nvim .config/tmux .config/alacritty .config/gh .config/shell)

# External resources: path|url|type|name
EXTRAS=(
    "$HOME/.git-prompt.sh|https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh|curl|git-prompt.sh"
    "$HOME/.config/alacritty/themes|https://github.com/alacritty/alacritty-theme|git|Alacritty themes"
    "$HOME/.tmux/plugins/tpm|https://github.com/tmux-plugins/tpm|git|TPM"
)

# Cleanup paths for uninstall: path|display_name
CLEANUPS=(
    "$HOME/.config/alacritty/themes|Alacritty themes"
    "$HOME/.git-prompt.sh|git-prompt.sh"
    "${XDG_DATA_HOME:-$HOME/.local/share}/zinit|Zinit"
    "$HOME/.local/share/nvim|Neovim data"
    "$HOME/.tmux/plugins|Tmux plugins"
)

# ==============================================================================
# Logging
# ==============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

log_header() {
    echo
    echo -e "${BOLD}${BLUE}dotfiles${NC} ${DIM}v${VERSION}${NC}"
    echo -e "${DIM}────────────────────────────────────${NC}"
}

log_info()    { echo -e "${BLUE}::${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC}  $1"; }
log_warn()    { echo -e "${YELLOW}!${NC}  $1"; }
log_error()   { echo -e "${RED}✗${NC}  $1" >&2; }
log_dim()     { echo -e "${DIM}   $1${NC}"; }

log_step() {
    local step=$1 total=$2 title=$3
    echo
    echo -e "${BOLD}[${step}/${total}]${NC} ${title}"
}

log_result() {
    local ok=$1 fail=$2 warn=${3:-0}
    echo
    echo -ne "${DIM}Results:${NC} "
    [[ $ok -gt 0 ]] && echo -ne "${GREEN}${ok} passed${NC} "
    [[ $fail -gt 0 ]] && echo -ne "${RED}${fail} failed${NC} "
    [[ $warn -gt 0 ]] && echo -ne "${YELLOW}${warn} warnings${NC}"
    echo
}

# ==============================================================================
# Helpers
# ==============================================================================

run() {
    if $DRY_RUN; then
        log_dim "dry-run: $*"
    else
        $VERBOSE && log_dim "exec: $*"
        "$@"
    fi
}

has_cmd() { command -v "$1" &>/dev/null; }
has_path() { [[ -e "$1" ]]; }

detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif has_cmd dnf; then
        echo "fedora"
    elif has_cmd apt; then
        echo "debian"
    else
        echo "unknown"
    fi
}

usage() {
    cat <<EOF
${BOLD}Usage:${NC} $(basename "$0") [command] [options]

${BOLD}Commands:${NC}
    install     Install dotfiles and dependencies (default)
    uninstall   Remove dotfiles symlinks
    health      Check installation status

${BOLD}Options:${NC}
    -n, --dry-run   Preview changes without applying
    -v, --verbose   Show detailed output
    -h, --help      Show this help

${BOLD}Examples:${NC}
    ./setup              # Install everything
    ./setup --dry-run    # Preview install
    ./setup health       # Check status
    ./setup uninstall    # Remove dotfiles
EOF
    exit 0
}

# ==============================================================================
# Commands
# ==============================================================================

cmd_health() {
    log_header
    log_info "Running health check"

    local ok=0 fail=0 warn=0

    # Symlinks
    log_step 1 3 "Symlinks"
    for f in "${MANAGED_FILES[@]}"; do
        if [[ -L "$HOME/$f" ]]; then
            log_success "$f"
            ((++ok))
        elif [[ -d "$HOME/$f" ]]; then
            # Directory exists (stow creates dirs, symlinks files inside)
            log_success "$f/"
            ((++ok))
        elif [[ -e "$HOME/$f" ]]; then
            log_warn "$f exists but not symlinked"
            ((++warn))
        else
            log_error "$f missing"
            ((++fail))
        fi
    done

    # Dependencies
    log_step 2 3 "Dependencies"
    for item in "${DEPS[@]}"; do
        IFS='|' read -r cmd _ _ _ <<< "$item"
        [[ "$cmd" == "-" ]] && continue  # Skip platform-specific
        if has_cmd "$cmd"; then
            log_success "$cmd"
            ((++ok))
        else
            log_error "$cmd not found"
            ((++fail))
        fi
    done

    # Plugin managers
    log_step 3 3 "Plugin managers"
    local plugins=(
        "${XDG_DATA_HOME:-$HOME/.local/share}/zinit|Zinit"
        "$HOME/.local/share/nvim/lazy|Neovim Lazy"
        "$HOME/.tmux/plugins/tpm|TPM"
    )
    for item in "${plugins[@]}"; do
        local path="${item%%|*}" name="${item##*|}"
        if has_path "$path"; then
            log_success "$name"
            ((++ok))
        else
            log_warn "$name not installed"
            ((++warn))
        fi
    done

    log_result $ok $fail $warn
}

cmd_uninstall() {
    log_header
    log_info "Uninstalling dotfiles"
    $DRY_RUN && log_warn "Dry run mode - no changes will be made"

    has_cmd stow || { log_error "stow is required but not installed"; exit 1; }

    log_step 1 2 "Removing symlinks"
    cd "$DOTFILES_DIR"
    run stow --target="$HOME" --delete .
    $DRY_RUN && log_success "Symlinks ready to remove" || log_success "Symlinks removed"

    if $DRY_RUN; then
        log_step 2 2 "Cleanup (skipped in dry-run)"
        return
    fi

    log_step 2 2 "Optional cleanup"
    log_dim "Press y to remove, n to skip"
    echo
    for item in "${CLEANUPS[@]}"; do
        local path="${item%%|*}" name="${item##*|}"
        if has_path "$path"; then
            read -p "   Remove $name? [y/N] " -n 1 -r; echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                rm -rf "$path"
                log_success "Removed $name"
            else
                log_dim "Skipped $name"
            fi
        fi
    done

    rm -rf "$HOME/.local/state/nvim" "$HOME/.cache/nvim" 2>/dev/null || true

    echo
    log_success "Uninstall complete"
    log_dim "System packages were not removed"
}

cmd_install() {
    log_header
    local os=$(detect_os)
    log_info "Installing dotfiles"
    log_dim "OS: $os | Dir: $DOTFILES_DIR"
    $DRY_RUN && log_warn "Dry run mode - no changes will be made"

    # Step 1: Backup
    log_step 1 4 "Backup existing configs"
    local backed_up=0
    if ! $DRY_RUN; then
        local need_backup=false
        for f in "${MANAGED_FILES[@]}"; do
            [[ -e "$HOME/$f" && ! -L "$HOME/$f" ]] && need_backup=true && break
        done
        if $need_backup; then
            local backup_dir="$HOME/.dotfiles-backup-$(date +%Y%m%d-%H%M%S)"
            log_dim "Backup directory: $backup_dir"
            mkdir -p "$backup_dir"
            for f in "${MANAGED_FILES[@]}"; do
                if [[ -e "$HOME/$f" && ! -L "$HOME/$f" ]]; then
                    cp -r "$HOME/$f" "$backup_dir/"
                    log_success "Backed up $f"
                    ((++backed_up))
                fi
            done
        fi
    fi
    [[ $backed_up -eq 0 ]] && log_success "No backup needed"

    # Step 2: Dependencies
    log_step 2 4 "Install dependencies"
    install_deps "$os"

    # Step 3: Extras
    log_step 3 4 "Install extras"
    install_extras

    # Step 4: Symlinks
    log_step 4 4 "Create symlinks"
    cd "$DOTFILES_DIR"
    if $DRY_RUN; then
        log_dim "stow --target=\$HOME --restow ."
        log_success "Symlinks ready (dry-run)"
    else
        stow --target="$HOME" --restow .
        log_success "Symlinks created"
    fi

    # Done
    echo
    echo -e "${GREEN}${BOLD}Installation complete!${NC}"
    echo
    echo -e "${BOLD}Next steps:${NC}"
    echo -e "  ${CYAN}1.${NC} source ~/.zshrc"
    echo -e "  ${CYAN}2.${NC} p10k configure"
    echo -e "  ${CYAN}3.${NC} nvim ${DIM}(plugins auto-install)${NC}"
    echo -e "  ${CYAN}4.${NC} tmux, then ${BOLD}Ctrl+Space I${NC}"
    echo
    echo -e "${DIM}Run ./setup health to verify${NC}"
    echo
}

# ==============================================================================
# Install Helpers
# ==============================================================================

get_packages() {
    local col=$1
    local packages=()
    for item in "${DEPS[@]}"; do
        local pkg=$(echo "$item" | cut -d'|' -f"$col")
        [[ "$pkg" != "-" ]] && packages+=("$pkg")
    done
    echo "${packages[@]}"
}

install_deps() {
    local os=$1

    case "$os" in
        macos)
            if ! has_cmd brew; then
                log_info "Installing Homebrew..."
                run /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                eval "$(/opt/homebrew/bin/brew shellenv)"
            fi
            log_success "Homebrew ready"

            log_info "Installing packages..."
            local packages=($(get_packages 2))
            run brew install --quiet "${packages[@]}"

            log_info "Installing fonts..."
            for cask in "${CASKS[@]}"; do
                run brew install --quiet --cask "$cask"
            done
            ;;

        fedora)
            log_info "Installing EPEL repository..."
            run sudo dnf install -y epel-release 2>/dev/null || true

            log_info "Installing packages..."
            local packages=($(get_packages 3))
            run sudo dnf install -y "${packages[@]}"

            if ! has_cmd zoxide; then
                log_info "Installing zoxide..."
                run curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
            fi
            ;;

        debian)
            log_info "Updating package index..."
            run sudo apt update

            log_info "Installing packages..."
            local packages=($(get_packages 4))
            run sudo apt install -y "${packages[@]}"
            ;;

        *)
            log_warn "Unknown OS - please install dependencies manually"
            log_dim "Required: stow neovim fd ripgrep fzf zoxide tmux git curl zsh"
            has_cmd stow || { log_error "stow is required"; exit 1; }
            return
            ;;
    esac

    log_success "Dependencies installed"
}

install_extras() {
    for item in "${EXTRAS[@]}"; do
        IFS='|' read -r path url type name <<< "$item"
        if has_path "$path"; then
            log_success "$name (exists)"
        else
            log_info "Installing $name..."
            case "$type" in
                curl)
                    run curl -sS -o "$path" "$url"
                    ;;
                git)
                    run mkdir -p "$(dirname "$path")"
                    run git clone --depth 1 -q "$url" "$path"
                    ;;
            esac
            log_success "$name"
        fi
    done
}

# ==============================================================================
# Main
# ==============================================================================

main() {
    local command="install"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            install)      command="install"; shift ;;
            uninstall)    command="uninstall"; shift ;;
            health)       command="health"; shift ;;
            -n|--dry-run) DRY_RUN=true; shift ;;
            -v|--verbose) VERBOSE=true; shift ;;
            -h|--help)    usage ;;
            *)            log_error "Unknown option: $1"; usage ;;
        esac
    done

    case "$command" in
        install)   cmd_install ;;
        uninstall) cmd_uninstall ;;
        health)    cmd_health ;;
    esac
}

main "$@"
